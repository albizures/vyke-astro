---
export type Props = {
	dark?: string
	light?: string
}

const { dark = 'dark', light = 'cupcake' } = Astro.props;

---
<label class="swap swap-rotate btn btn-circle">
	<input type="checkbox" data-theme-toggle value="dark" />

	<div class="swap-on">
		<slot name="light" />
	</div>
	<div class="swap-off">
		<slot name="dark" />
	</div>
</label>

<script is:inline define:vars={{ dark, light }}>
import { on, query, select } from '@vyke/dom'

const [checkbox] = select(query('[data-theme-toggle]'))

if (!checkbox) {
	throw new Error('Missing checkbox element')
}

const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')

let changeOff
if (localStorage.getItem('v:theme') === null) {
	checkbox.checked = mediaQuery.matches

	changeOff = on(mediaQuery, 'change', (event) => {
		document.documentElement.dataset.theme = getTheme(event.matches)
	})
}

function getTheme(isDark) {
	return isDark ? dark : light
}

on(checkbox, 'change', () => {
	if (changeOff) {
		changeOff()
	}
	const theme = getTheme(checkbox.checked)

	document.documentElement.dataset.theme = theme
	localStorage.setItem('v:theme', theme)
})
</script>
